import 'package:flutter/material.dart';
import 'package:lucide_icons/lucide_icons.dart';
import 'package:image_picker/image_picker.dart';
import 'dart:io';

import '../../../core/services/supabase_service.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/widgets/burger_menu_leading.dart';

class ProjectFilesPage extends StatefulWidget {
  final String projectId;
  const ProjectFilesPage({super.key, required this.projectId});

  @override
  State<ProjectFilesPage> createState() => _ProjectFilesPageState();
}

class _ProjectFilesPageState extends State<ProjectFilesPage> {
  bool _loading = true;
  List<dynamic> _files = [];
  List<dynamic> _folders = [];
  String? _currentFolderId;
  String _currentFolderName = 'Dateien';
  final List<Map<String, String?>> _breadcrumbs = [];

  @override
  void initState() {
    super.initState();
    _load();
  }

  Future<void> _load() async {
    setState(() => _loading = true);
    final results = await Future.wait([
      SupabaseService.getFiles(widget.projectId, folderId: _currentFolderId),
      SupabaseService.getFolders(widget.projectId, parentId: _currentFolderId),
    ]);
    if (mounted) {
      setState(() {
        _files = results[0] as List<dynamic>;
        _folders = results[1] as List<dynamic>;
        _loading = false;
      });
    }
  }

  void _enterFolder(String folderId, String name) {
    _breadcrumbs.add({'id': _currentFolderId, 'name': _currentFolderName});
    _currentFolderId = folderId;
    _currentFolderName = name;
    _load();
  }

  void _goBack() {
    if (_breadcrumbs.isEmpty) return;
    final prev = _breadcrumbs.removeLast();
    _currentFolderId = prev['id'];
    _currentFolderName = prev['name'] ?? 'Dateien';
    _load();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.background,
      appBar: AppBar(
        title: Text(_currentFolderName),
        leading: _breadcrumbs.isNotEmpty
            ? IconButton(
                icon: const Icon(LucideIcons.arrowLeft),
                onPressed: _goBack,
              )
            : burgerMenuLeading(context),
      ),
      floatingActionButton: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          FloatingActionButton.small(
            heroTag: 'folder',
            onPressed: () => _createFolder(context),
            backgroundColor: AppColors.primary.withValues(alpha: 0.9),
            child: const Icon(LucideIcons.folderPlus, size: 20, color: Colors.white),
          ),
          const SizedBox(height: 10),
          FloatingActionButton(
            heroTag: 'upload',
            onPressed: () => _uploadFile(),
            backgroundColor: const Color(0xFFF59E0B),
            child: const Icon(LucideIcons.upload, color: Colors.white),
          ),
        ],
      ),
      body: _loading
          ? const Center(child: CircularProgressIndicator())
          : RefreshIndicator(
              onRefresh: _load,
              child: (_folders.isEmpty && _files.isEmpty)
                  ? ListView(children: const [
                      SizedBox(height: 120),
                      Center(
                        child: Column(children: [
                          Icon(LucideIcons.folderOpen,
                              size: 48, color: AppColors.textTertiary),
                          SizedBox(height: 12),
                          Text('Keine Dateien',
                              style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.w600,
                                  color: AppColors.textSecondary)),
                        ]),
                      ),
                    ])
                  : ListView(
                      padding: const EdgeInsets.fromLTRB(16, 12, 16, 100),
                      children: [
                        // Folders
                        ..._folders.map((f) => _FolderTile(
                              name: f['name'] ?? 'Ordner',
                              onTap: () =>
                                  _enterFolder(f['id'], f['name'] ?? 'Ordner'),
                            )),
                        if (_folders.isNotEmpty && _files.isNotEmpty)
                          const Padding(
                            padding: EdgeInsets.symmetric(vertical: 8),
                            child: Divider(),
                          ),
                        // Files
                        ..._files.map((f) => _FileTile(file: f)),
                      ],
                    ),
            ),
    );
  }

  void _createFolder(BuildContext ctx) {
    final ctrl = TextEditingController();
    showDialog(
      context: ctx,
      builder: (context) => AlertDialog(
        title: const Text('Neuer Ordner'),
        content: TextField(
          controller: ctrl,
          decoration: const InputDecoration(hintText: 'Ordnername'),
          autofocus: true,
        ),
        actions: [
          TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('Abbrechen')),
          ElevatedButton(
            onPressed: () async {
              if (ctrl.text.trim().isEmpty) return;
              await SupabaseService.createFolder(widget.projectId, {
                'name': ctrl.text.trim(),
                'parent_id': _currentFolderId,
              });
              if (context.mounted) Navigator.pop(context);
              _load();
            },
            child: const Text('Erstellen'),
          ),
        ],
      ),
    );
  }

  Future<void> _uploadFile() async {
    final picker = ImagePicker();
    final image = await picker.pickImage(source: ImageSource.gallery);
    if (image == null) return;

    setState(() => _loading = true);
    try {
      final file = File(image.path);
      final bytes = await file.readAsBytes();
      final fileName = image.name;
      final path = 'projects/${widget.projectId}/files/$fileName';

      await SupabaseService.uploadFileSimple(path, bytes, fileName);

      // Also create a file record in the database
      await SupabaseService.createFile(widget.projectId, {
        'name': fileName,
        'file_path': path,
        'file_size': bytes.length,
        'mime_type': 'image/${fileName.split('.').last}',
        'folder_id': _currentFolderId,
      });
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Fehler: $e')),
        );
      }
    }
    _load();
  }
}

class _FolderTile extends StatelessWidget {
  final String name;
  final VoidCallback onTap;

  const _FolderTile({required this.name, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Material(
        color: AppColors.surface,
        borderRadius: BorderRadius.circular(12),
        child: InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(12),
          child: Container(
            padding: const EdgeInsets.all(14),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: AppColors.border),
            ),
            child: Row(
              children: [
                Container(
                  width: 40,
                  height: 40,
                  decoration: BoxDecoration(
                    color: const Color(0xFFF59E0B).withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: const Icon(LucideIcons.folder,
                      size: 20, color: Color(0xFFF59E0B)),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(name,
                      style: const TextStyle(
                          fontSize: 15,
                          fontWeight: FontWeight.w600,
                          color: AppColors.text)),
                ),
                const Icon(LucideIcons.chevronRight,
                    size: 18, color: AppColors.textTertiary),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _FileTile extends StatelessWidget {
  final Map<String, dynamic> file;

  const _FileTile({required this.file});

  @override
  Widget build(BuildContext context) {
    final name = file['name'] ?? 'Datei';
    final size = file['file_size'];
    final mime = file['mime_type'] ?? '';

    IconData icon;
    Color color;
    if (mime.contains('image')) {
      icon = LucideIcons.image;
      color = const Color(0xFF10B981);
    } else if (mime.contains('pdf')) {
      icon = LucideIcons.fileText;
      color = AppColors.danger;
    } else if (mime.contains('word') || mime.contains('document')) {
      icon = LucideIcons.fileText;
      color = const Color(0xFF3B82F6);
    } else {
      icon = LucideIcons.file;
      color = AppColors.textSecondary;
    }

    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Container(
        padding: const EdgeInsets.all(14),
        decoration: BoxDecoration(
          color: AppColors.surface,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.border),
        ),
        child: Row(
          children: [
            Container(
              width: 40,
              height: 40,
              decoration: BoxDecoration(
                color: color.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(10),
              ),
              child: Icon(icon, size: 20, color: color),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(name,
                      style: const TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                          color: AppColors.text),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis),
                  if (size != null)
                    Text(_formatSize(size),
                        style: const TextStyle(
                            fontSize: 12, color: AppColors.textTertiary)),
                ],
              ),
            ),
            IconButton(
              icon: const Icon(LucideIcons.download,
                  size: 18, color: AppColors.textSecondary),
              onPressed: () {},
            ),
          ],
        ),
      ),
    );
  }

  String _formatSize(dynamic size) {
    final bytes = size is int ? size : int.tryParse(size.toString()) ?? 0;
    if (bytes < 1024) return '$bytes B';
    if (bytes < 1048576) return '${(bytes / 1024).toStringAsFixed(1)} KB';
    return '${(bytes / 1048576).toStringAsFixed(1)} MB';
  }
}
